<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg:#0f172a; --card:#020617; --accent:#2563eb;
  --muted:#334155; --danger:#dc2626;
}

* { box-sizing:border-box; }

body {
  margin:0; padding:14px;
  font-family:system-ui;
  background:var(--bg); color:#e5e7eb;
}

h1 { margin-bottom:8px; }

/* ===== CALENDAR ===== */
#calendar {
  background:var(--card);
  border-radius:16px;
  padding:12px;
  margin-bottom:14px;
}

#cal-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

#cal-grid {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}

.weekday {
  text-align:center;
  font-size:12px;
  opacity:.6;
}

.day {
  text-align:center;
  padding:8px 0;
  border-radius:8px;
  cursor:pointer;
  opacity:.4;
}

.day.active {
  background:var(--accent);
  opacity:1;
  font-weight:600;
}

.day.selected {
  outline:2px solid white;
}

/* ===== WORKOUT CARD ===== */
.workout {
  background:var(--card);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
  animation:fadeUp .25s ease;
}

@keyframes fadeUp {
  from {opacity:0; transform:translateY(6px);}
  to {opacity:1; transform:none;}
}

.workout-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.exercise {
  margin-top:8px;
  padding-top:6px;
  border-top:1px solid #1e293b;
}

/* ===== BUTTONS ===== */
button {
  border:none;
  border-radius:10px;
  padding:8px 10px;
  background:var(--accent);
  color:white;
}

.secondary { background:var(--muted); }
.danger { background:var(--danger); }

/* ===== FAB ===== */
#fab {
  position:fixed;
  right:16px;
  bottom:16px;
  width:56px; height:56px;
  border-radius:50%;
  font-size:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ===== MODAL ===== */
#modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;
  z-index:1000;
}

#modal.show { display:flex; }

#modalContent {
  background:var(--card);
  width:100%;
  max-width:420px;
  max-height:90vh;
  overflow:auto;
  border-radius:16px;
  padding:14px;
}

input {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  margin-top:6px;
}

.set {
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:8px;
  margin-top:6px;
}
</style>
</head>

<body>

<h1>üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>

<div id="calendar">
  <div id="cal-header">
    <button type="button" class="secondary" onclick="prevMonth()">‚Äπ</button>
    <strong id="cal-title"></strong>
    <button type="button" class="secondary" onclick="nextMonth()">‚Ä∫</button>
  </div>
  <div id="cal-grid"></div>
</div>

<button type="button" class="secondary" onclick="clearFilter()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>

<div id="workouts"></div>

<button id="fab" type="button" onclick="openAdd()">+</button>

<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle"></h3>
    <input type="date" id="workoutDate">
    <div id="modalExercises"></div>

    <button type="button" onclick="addExercise()">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button><br><br>

    <button type="button" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button type="button" class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const telegramId = Telegram.WebApp.initDataUnsafe.user.id;

let workouts=[];
let selectedDate=null;
let current=new Date();
let editingId=null;

/* ===== LOAD ===== */
async function loadWorkouts(){
  const r=await fetch(`${API}/workouts/${telegramId}`,{
    headers:{ "ngrok-skip-browser-warning":"true" }
  });
  workouts=await r.json();
  renderCalendar();
  render();
}

/* ===== CALENDAR ===== */
function renderCalendar(){
  const grid=document.getElementById("cal-grid");
  const title=document.getElementById("cal-title");
  grid.innerHTML="";

  const year=current.getFullYear();
  const month=current.getMonth();

  title.innerText=current.toLocaleDateString("ru",{month:"long",year:"numeric"});

  const firstDay=new Date(year,month,1).getDay()||7;
  const daysInMonth=new Date(year,month+1,0).getDate();

  ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"].forEach(d=>{
    const w=document.createElement("div");
    w.className="weekday"; w.innerText=d;
    grid.append(w);
  });

  for(let i=1;i<firstDay;i++) grid.append(document.createElement("div"));

  for(let d=1;d<=daysInMonth;d++){
    const date=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const hasWorkout=workouts.some(w=>w.workout_date===date);

    const el=document.createElement("div");
    el.className="day"+(hasWorkout?" active":"")+(selectedDate===date?" selected":"");
    el.innerText=d;
    el.onclick=()=>{ selectedDate=date; renderCalendar(); render(); };
    grid.append(el);
  }
}

function prevMonth(){ current.setMonth(current.getMonth()-1); renderCalendar(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderCalendar(); }
function clearFilter(){ selectedDate=null; renderCalendar(); render(); }

/* ===== RENDER ===== */
function render(){
  const root=document.getElementById("workouts");
  root.innerHTML="";

  workouts
    .filter(w=>!selectedDate||w.workout_date===selectedDate)
    .forEach(w=>{
      const c=document.createElement("div");
      c.className="workout";
      c.innerHTML=`<div class="workout-header">
        <strong>${w.workout_date}</strong>
        <div>
          <button type="button" onclick="openEdit(${w.id})">‚úèÔ∏è</button>
          <button type="button" class="danger" onclick="del(${w.id})">üóë</button>
        </div></div>`;
      w.info.exercises.forEach(ex=>{
        c.innerHTML+=`<div class="exercise"><b>${ex.name}</b><br>`+
          ex.sets.map(s=>`${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")+
        `</div>`;
      });
      root.append(c);
    });
}

/* ===== MODAL ===== */
function openAdd(){
  editingId=null;
  modalTitle.innerText="–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
  workoutDate.value=new Date().toISOString().slice(0,10);
  modalExercises.innerHTML="";
  modal.classList.add("show");
}

function openEdit(id){
  editingId=id;
  const w=workouts.find(x=>x.id===id);
  modalTitle.innerText="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
  workoutDate.value=w.workout_date;
  modalExercises.innerHTML="";
  w.info.exercises.forEach(addExercise);
  modal.classList.add("show");
}

function closeModal(){ modal.classList.remove("show"); }

function addExercise(data=null){
  const e=document.createElement("div");
  e.className="exercise";
  e.innerHTML=`<input class="ex-name" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" value="${data?.name||""}">
    <div class="sets"></div>
    <button type="button" onclick="addSet(this)">‚ûï –ü–æ–¥—Ö–æ–¥</button>`;
  modalExercises.append(e);
  data?.sets.forEach(s=>addSet(e.querySelector("button"),s));
}

function addSet(btn,data=null){
  const s=document.createElement("div");
  s.className="set";
  s.innerHTML=`<input type="number" placeholder="–í–µ—Å" value="${data?.weight||""}">
    <input type="number" placeholder="–ü–æ–≤—Ç." value="${data?.reps||""}">
    <button type="button" class="danger" onclick="this.parentNode.remove()">‚úï</button>`;
  btn.previousElementSibling.append(s);
}

/* ===== SAVE ===== */
async function saveWorkout(){
  const exercises=[...document.querySelectorAll(".exercise")].map(ex=>({
    name:ex.querySelector(".ex-name").value,
    sets:[...ex.querySelectorAll(".set")].map(s=>({
      weight:+s.children[0].value,
      reps:+s.children[1].value
    }))
  }));

  const body={ workout_date:workoutDate.value, info:{exercises} };
  const url=editingId?`${API}/workouts/${editingId}`:`${API}/workouts/${telegramId}`;
  const method=editingId?"PUT":"POST";

  await fetch(url,{
    method,
    headers:{
      "Content-Type":"application/json",
      "ngrok-skip-browser-warning":"true"
    },
    body:JSON.stringify(body)
  });

  closeModal();
  loadWorkouts();
}

async function del(id){
  await fetch(`${API}/workouts/${id}`,{
    method:"DELETE",
    headers:{ "ngrok-skip-browser-warning":"true" }
  });
  loadWorkouts();
}

loadWorkouts();
</script>
</body>
</html>
