<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #0f172a;
      color: #e5e7eb;
    }

    h1, h2 {
      margin: 8px 0;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: white;
      font-size: 16px;
    }

    button.danger {
      background: #dc2626;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
    }

    .exercise, .set {
      margin-top: 6px;
      padding-left: 8px;
    }

    .set {
      font-size: 14px;
      opacity: 0.9;
    }

    .log {
      background: #020617;
      padding: 8px;
      font-size: 12px;
      margin-top: 10px;
      border-radius: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>

<div class="card">
  <strong>Telegram ID:</strong>
  <div id="tg-id">‚Äî</div>
</div>

<button onclick="loadWorkouts()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>

<div id="workouts"></div>

<button onclick="addDemoWorkout()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<div class="log" id="log"></div>

<script>
  const API_BASE = "https://ula-conductorial-vagrantly.ngrok-free.dev";
  const LOG = document.getElementById("log");

  function log(msg) {
    LOG.textContent += msg + "\n";
  }

  // ===== Telegram ID =====
  let telegramId = null;

  if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
    telegramId = Telegram.WebApp.initDataUnsafe.user.id;
  } else {
    telegramId = 505375162; // fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
  }

  document.getElementById("tg-id").textContent = telegramId;

  // ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ =====
  async function loadWorkouts() {
    log("–ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫...");

    try {
      const res = await fetch(
        `${API_BASE}/workouts/${telegramId}?ngrok-skip-browser-warning=1`,
        {
          headers: {
            "ngrok-skip-browser-warning": "true"
          }
        }
      );

      log("HTTP —Å—Ç–∞—Ç—É—Å: " + res.status);

      const data = await res.json();
      renderWorkouts(data);

    } catch (e) {
      log("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  // ===== –†–µ–Ω–¥–µ—Ä =====
  function renderWorkouts(workouts) {
    const container = document.getElementById("workouts");
    container.innerHTML = "";

    if (!workouts.length) {
      container.innerHTML = "<p>–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>";
      return;
    }

    workouts.forEach(w => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h2>${w.workout_date}</h2>
        ${w.info.exercises.map(ex => `
          <div class="exercise">
            <strong>${ex.name}</strong>
            ${ex.sets.map(s => `
              <div class="set">‚öñ ${s.weight} –∫–≥ √ó ${s.reps}</div>
            `).join("")}
          </div>
        `).join("")}
        <button class="danger" onclick="deleteWorkout(${w.id})">–£–¥–∞–ª–∏—Ç—å</button>
      `;

      container.appendChild(card);
    });
  }

  // ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ (–¥–µ–º–æ) =====
  async function addDemoWorkout() {
    const payload = {
      workout_date: new Date().toISOString(),
      info: {
        exercises: [
          {
            name: "–ù–æ–≥–∏",
            sets: [
              { weight: 60, reps: 15 },
              { weight: 70, reps: 10 }
            ]
          },
          {
            name: "–°–ø–∏–Ω–∞",
            sets: [
              { weight: 40, reps: 12 }
            ]
          }
        ]
      }
    };

    log("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...");

    await fetch(
      `${API_BASE}/workouts/${telegramId}?ngrok-skip-browser-warning=1`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ngrok-skip-browser-warning": "true"
        },
        body: JSON.stringify(payload)
      }
    );

    loadWorkouts();
  }

  // ===== –£–¥–∞–ª–µ–Ω–∏–µ =====
  async function deleteWorkout(id) {
    await fetch(
      `${API_BASE}/workouts/${id}?ngrok-skip-browser-warning=1`,
      {
        method: "DELETE",
        headers: {
          "ngrok-skip-browser-warning": "true"
        }
      }
    );

    loadWorkouts();
  }

  // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
  loadWorkouts();
</script>

</body>
</html>
