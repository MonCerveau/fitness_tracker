<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin:0;
  padding:14px;
  font-family:system-ui;
  background:#0f172a;
  color:#e5e7eb;
}
.card {
  background:#020617;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
button {
  padding:10px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
}
.secondary { background:#334155; }
.danger { background:#dc2626; }

.exercise {
  margin-top:8px;
  border-top:1px solid #1e293b;
  padding-top:8px;
}
.set {
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:8px;
  margin-top:6px;
}

#fab {
  position:fixed;
  right:16px;
  bottom:16px;
  width:56px;
  height:56px;
  border-radius:50%;
  font-size:28px;
}

#modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;
}
#modal.show { display:flex; }

#modalContent {
  background:#020617;
  width:100%;
  max-width:420px;
  max-height:90vh;
  overflow:auto;
  border-radius:16px;
  padding:14px;
}
</style>
</head>

<body>

<h2>üèãÔ∏è –ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
<div id="workouts"></div>

<button id="fab" onclick="openAdd()">+</button>

<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
    <h3>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>

    <select id="workoutType"></select>
    <input type="date" id="workoutDate">

    <div id="exerciseList"></div>

    <button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;

let workouts = [];
let template = null;

// ===== LOAD =====

async function loadWorkouts(){
  const r = await fetch(`${API}/workouts/${telegramId}`);
  workouts = await r.json();
  render();
}

async function loadWorkoutTypes(){
  const r = await fetch(`${API}/workout-types/${telegramId}`);
  const types = await r.json();
  workoutType.innerHTML = types.map(t =>
    `<option value="${t.id}">${t.name}</option>`
  ).join("");
}

// ===== UI =====

function render(){
  workoutsDiv.innerHTML = "";
  workouts.forEach(w => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<b>${w.workout_date}</b>`;
    w.info.exercises.forEach(ex => {
      c.innerHTML += `<div class="exercise">
        <b>${ex.name}</b><br>
        ${ex.sets.map(s => `${s.weight || "-"} –∫–≥ √ó ${s.reps}`).join("<br>")}
      </div>`;
    });
    workoutsDiv.append(c);
  });
}

function openAdd(){
  workoutDate.value = new Date().toISOString().slice(0,10);
  loadWorkoutTypes();
  modal.classList.add("show");
}

function closeModal(){
  modal.classList.remove("show");
  exerciseList.innerHTML = "";
}

async function loadTemplate(){
  const id = workoutType.value;
  const r = await fetch(`${API}/workout-template/${id}`);
  template = await r.json();

  exerciseList.innerHTML = "";
  template.exercises.forEach(ex => {
    const e = document.createElement("div");
    e.className = "exercise";
    e.innerHTML = `<b>${ex.name}</b>`;
    for(let i=0;i<3;i++){
      e.innerHTML += `
        <div class="set">
          <input type="number" placeholder="–í–µ—Å">
          <input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã">
        </div>`;
    }
    exerciseList.append(e);
  });
}

workoutType.onchange = loadTemplate;

// ===== SAVE =====

async function saveWorkout(){
  const exercises = [...document.querySelectorAll(".exercise")].map((ex,i)=>({
    exercise_id: template.exercises[i].id,
    name: template.exercises[i].name,
    sets: [...ex.querySelectorAll(".set")].map(s=>({
      weight: +s.children[0].value || null,
      reps: +s.children[1].value
    }))
  }));

  await fetch(`${API}/workouts/${telegramId}`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      workout_type_id: workoutType.value,
      workout_date: workoutDate.value,
      info:{ exercises }
    })
  });

  closeModal();
  loadWorkouts();
}

const workoutsDiv = document.getElementById("workouts");

loadWorkouts();
</script>

</body>
</html>

