<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }
body { margin: 0; background: #0f0f0f; color: #fff; }

header {
  padding: 16px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
}

#calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  padding: 12px;
}

.day {
  padding: 10px;
  border-radius: 10px;
  background: #1e1e1e;
  text-align: center;
  cursor: pointer;
}

.day.has { background: #2563eb; }
.day.active { outline: 2px solid #fff; }

#workouts { padding: 12px; }

.card {
  background: #1e1e1e;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 12px;
}

.card h3 { margin: 0 0 6px; }

.exercise { margin-top: 6px; font-size: 14px; }

.set { color: #aaa; margin-left: 8px; }

.fab {
  position: fixed;
  right: 16px;
  bottom: 16px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #2563eb;
  color: #fff;
  font-size: 32px;
  border: none;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal.open { display: flex; }

.modal-content {
  background: #121212;
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 16px;
  padding: 16px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 8px;
  border: none;
}

.row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.row input { flex: 1; }

.small {
  width: 36px;
  height: 36px;
  border-radius: 8px;
}

button {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 10px;
}

button.secondary { background: #333; }
button.danger { background: #dc2626; }

.actions {
  display: flex;
  gap: 8px;
}
</style>
</head>

<body>

<header>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</header>

<div id="calendar"></div>
<div id="workouts"></div>

<button class="fab" id="openAdd">+</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>

    <input type="date" id="workoutDate">

    <div id="exercises"></div>

    <button onclick="addExercise()">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>

    <div class="actions">
      <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
const API = 'https://ula-conductorial-vagrantly.ngrok-free.dev';
const tg = window.Telegram?.WebApp;
const telegramId = tg?.initDataUnsafe?.user?.id || 505375162;

let workouts = [];
let selectedDate = null;
let editingId = null;

/* ===== LOAD ===== */
async function loadWorkouts() {
  const res = await fetch(`${API}/workouts/${telegramId}`);
  workouts = await res.json();
  renderCalendar();
  renderWorkouts();
}

/* ===== CALENDAR ===== */
function renderCalendar() {
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';

  const dates = [...new Set(workouts.map(w => w.workout_date))];
  for (let d = 1; d <= 31; d++) {
    const el = document.createElement('div');
    el.className = 'day';
    el.innerText = d;
    const full = dates.find(x => new Date(x).getDate() === d);
    if (full) el.classList.add('has');
    el.onclick = () => {
      selectedDate = full || null;
      document.querySelectorAll('.day').forEach(x => x.classList.remove('active'));
      el.classList.add('active');
      renderWorkouts();
    };
    cal.appendChild(el);
  }
}

/* ===== WORKOUT LIST ===== */
function renderWorkouts() {
  const box = document.getElementById('workouts');
  box.innerHTML = '';

  workouts
    .filter(w => !selectedDate || w.workout_date === selectedDate)
    .forEach(w => {
      const c = document.createElement('div');
      c.className = 'card';

      c.innerHTML = `
        <h3>${w.workout_date}</h3>
        ${w.info.exercises.map(e =>
          `<div class="exercise">
            <b>${e.name}</b>
            ${e.sets.map(s => `<div class="set">${s.weight} –∫–≥ √ó ${s.reps}</div>`).join('')}
          </div>`
        ).join('')}
        <div class="actions">
          <button onclick="editWorkout(${w.id})">‚úèÔ∏è</button>
          <button class="danger" onclick="deleteWorkout(${w.id})">üóë</button>
        </div>
      `;
      box.appendChild(c);
    });
}

/* ===== MODAL ===== */
document.getElementById('openAdd').onclick = () => openModal();

function openModal(workout=null) {
  editingId = workout?.id || null;
  document.getElementById('modalTitle').innerText = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
  document.getElementById('workoutDate').value = workout?.workout_date || '';
  document.getElementById('exercises').innerHTML = '';
  workout?.info.exercises.forEach(addExerciseFromData);
  document.getElementById('modal').classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

/* ===== EXERCISES ===== */
function addExerciseFromData(ex) {
  const wrap = document.createElement('div');
  wrap.innerHTML = `<input value="${ex.name}">`;
  ex.sets.forEach(s => addSet(wrap, s));
  wrap.appendChild(btn('‚ûï –ü–æ–¥—Ö–æ–¥', () => addSet(wrap)));
  document.getElementById('exercises').appendChild(wrap);
}

function addExercise() {
  addExerciseFromData({ name:'', sets:[] });
}

function addSet(wrap, s={}) {
  const r = document.createElement('div');
  r.className = 'row';
  r.innerHTML = `
    <input placeholder="–∫–≥" value="${s.weight||''}">
    <input placeholder="–ø–æ–≤—Ç" value="${s.reps||''}">
  `;
  r.appendChild(btn('‚úñ', ()=>r.remove(),'small danger'));
  wrap.insertBefore(r, wrap.lastChild);
}

/* ===== SAVE ===== */
document.getElementById('saveBtn').addEventListener('click', saveWorkout);

async function saveWorkout() {
  const date = workoutDate.value;
  if (!date) return alert('–î–∞—Ç–∞');

  const exercises = [];
  document.querySelectorAll('#exercises > div').forEach(ex => {
    const name = ex.querySelector('input').value;
    const sets = [];
    ex.querySelectorAll('.row').forEach(r => {
      const i = r.querySelectorAll('input');
      sets.push({ weight:+i[0].value, reps:+i[1].value });
    });
    if (name && sets.length) exercises.push({ name, sets });
  });

  const payload = { workout_date: date, info:{exercises} };
  const method = editingId ? 'PUT' : 'POST';
  const url = editingId
    ? `${API}/workouts/${editingId}`
    : `${API}/workouts/${telegramId}`;

  await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  closeModal();
  loadWorkouts();
}

/* ===== EDIT / DELETE ===== */
function editWorkout(id) {
  const w = workouts.find(x=>x.id===id);
  openModal(w);
}

async function deleteWorkout(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
  await fetch(`${API}/workouts/${id}`,{method:'DELETE'});
  loadWorkouts();
}

/* ===== UTILS ===== */
function btn(t,fn,cls='') {
  const b=document.createElement('button');
  b.innerText=t;b.className=cls;b.onclick=fn;return b;
}

loadWorkouts();
</script>
</body>
</html>
