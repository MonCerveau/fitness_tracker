<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Workout Diary</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { font-family: system-ui; background:#f2f2f2; padding:12px }
.card { background:#fff; padding:12px; border-radius:10px; margin-bottom:10px }
button { padding:6px 10px; border-radius:6px; border:none }
.primary { background:#2a8cff; color:#fff }
.secondary { background:#888; color:#fff }
.danger { background:#e74c3c; color:#fff }
input { width:100%; padding:6px; margin-bottom:6px }
.set { display:flex; gap:6px; margin-bottom:6px }
.exercise { border-top:1px solid #ddd; padding-top:8px; margin-top:8px }
</style>
</head>

<body>

<h3 id="uid"></h3>
<button class="primary" onclick="openCreate()">‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>

<div id="history"></div>

<!-- MODAL -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4)">
  <div style="background:#fff; padding:16px; border-radius:12px; margin:10% auto; width:95%; max-width:360px">
    <h4>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h4>
    <div id="exercises"></div>
    <button class="secondary" onclick="addExercise()">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button><br><br>
    <button class="primary" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;
uid.innerText = `Telegram ID: ${telegramId}`;

let currentWorkoutId = null;
let workoutExercises = [];

function parseInfo(raw) {
  if (!raw) return null;
  if (typeof raw === "object") return raw;
  try {
    return JSON.parse(raw.replace(/'/g,'"'));
  } catch {
    return null;
  }
}

function openCreate() {
  currentWorkoutId = null;
  workoutExercises = [];
  exercises.innerHTML = "";
  addExercise();
  modal.style.display = "block";
}

function closeModal() {
  modal.style.display = "none";
}

function addExercise(data = { name:"", sets:[] }) {
  const idx = workoutExercises.length;
  workoutExercises.push(data);

  const div = document.createElement("div");
  div.className = "exercise";
  div.innerHTML = `
    <input placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
    <div class="sets"></div>
    <button class="secondary">‚ûï –ü–æ–¥—Ö–æ–¥</button>
  `;

  const nameInput = div.querySelector("input");
  const setsDiv = div.querySelector(".sets");
  nameInput.value = data.name;
  nameInput.oninput = e => workoutExercises[idx].name = e.target.value;

  div.querySelector("button").onclick = () => addSet(idx, setsDiv);

  exercises.appendChild(div);
}

function addSet(exIdx, container) {
  const set = { weight:"", reps:"" };
  workoutExercises[exIdx].sets.push(set);

  const d = document.createElement("div");
  d.className = "set";
  d.innerHTML = `
    <input type="number" placeholder="–∫–≥">
    <input type="number" placeholder="—Ä–∞–∑">
  `;

  d.children[0].oninput = e => set.weight = Number(e.target.value);
  d.children[1].oninput = e => set.reps = Number(e.target.value);

  container.appendChild(d);
}

async function saveWorkout() {
  const info = { exercises: workoutExercises };

  const url = currentWorkoutId
    ? `${API}/workouts/${currentWorkoutId}`
    : `${API}/workouts/${telegramId}`;

  await fetch(url, {
    method: currentWorkoutId ? "PUT" : "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      workout_date: new Date().toISOString(),
      info
    })
  });

  closeModal();
  loadHistory();
}

async function loadHistory() {
  const r = await fetch(`${API}/workouts/${telegramId}`);
  const data = await r.json();
  history.innerHTML = "";

  data.forEach(w => {
    const info = parseInfo(w.info);
    if (!info) return;

    const exercisesList = info.exercises
      || [{ name: info.exercise, sets: info.sets }];

    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = exercisesList.map(e => `
      <b>${e.name}</b><br>
      ${e.sets.map(s => `${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")}
    `).join("<hr>");

    history.appendChild(c);
  });
}

loadHistory();
</script>
</body>
</html>
