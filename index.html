<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    .container {
      padding: 12px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .exercise {
      margin-top: 6px;
      font-weight: 600;
    }
    .set {
      font-size: 14px;
      margin-left: 10px;
      color: #444;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: none;
      background: #2a8cff;
      color: #fff;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="container">
    <button id="addBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    <div id="history"></div>
  </div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe?.user?.id;
const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev";

async function loadHistory() {
  const history = document.getElementById("history");
  history.innerHTML = "";

  const r = await fetch(`${API_URL}/workouts/${telegramId}`);
  const data = await r.json();

  data.forEach(w => {
    const card = document.createElement("div");
    card.className = "card";

    const date = document.createElement("div");
    date.innerText = "üìÖ " + w.workout_date;
    card.appendChild(date);

    w.info.exercises.forEach(ex => {
      const exDiv = document.createElement("div");
      exDiv.className = "exercise";
      exDiv.innerText = ex.name;
      card.appendChild(exDiv);

      ex.sets.forEach(s => {
        const setDiv = document.createElement("div");
        setDiv.className = "set";
        setDiv.innerText = `${s.weight} –∫–≥ √ó ${s.reps}`;
        card.appendChild(setDiv);
      });
    });

    history.appendChild(card);
  });
}

/* üîë –ì–õ–ê–í–ù–û–ï ‚Äî –∑–∞–ø—É—Å–∫ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ DOM */
document.addEventListener("DOMContentLoaded", () => {
  loadHistory();
});

/* üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä) */
document.getElementById("addBtn").onclick = async () => {
  await fetch(`${API_URL}/workouts/${telegramId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      workout_date: new Date().toISOString(),
      info: {
        exercises: [
          {
            name: "–ù–æ–≥–∏",
            sets: [{ weight: 60, reps: 15 }]
          }
        ]
      }
    })
  });

  await loadHistory(); // ‚Üê –í–û–¢ –≠–¢–û–ì–û –†–ê–ù–¨–®–ï –ù–ï –ë–´–õ–û
};
</script>
</body>
</html>
