<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { font-family: system-ui; background:#f4f4f4; padding:16px; }
.card { background:#fff; padding:12px; border-radius:12px; margin-bottom:10px; }
button { padding:8px 12px; border-radius:8px; border:none; background:#2a8cff; color:white; }
button.danger { background:#e74c3c; }
button.secondary { background:#888; }
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.4);
  display:none; align-items:center; justify-content:center;
}
.modal-content {
  background:#fff; padding:16px; border-radius:12px; width:300px;
}
input { width:100%; margin-bottom:8px; padding:6px; }
.set { display:flex; gap:4px; margin-bottom:4px; }
</style>
</head>

<body>

<h3>üë§ Telegram ID</h3>
<div id="uid"></div>

<button onclick="openAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è</h3>
<div id="history"></div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h4 id="modalTitle"></h4>
    <input id="exercise" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
    <div id="sets"></div>
    <button class="secondary" onclick="addSet()">‚ûï –ü–æ–¥—Ö–æ–¥</button><br><br>
    <button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="secondary" onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;
document.getElementById("uid").innerText = telegramId;

const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";

let currentWorkoutId = null;
let sets = [];

function safeParse(s){ try{return JSON.parse(s)}catch{return null} }

function openAdd(){
  currentWorkoutId=null;
  sets=[];
  exercise.value="";
  setsDiv.innerHTML="";
  addSet();
  showModal("–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞");
}
function openEdit(w){
  currentWorkoutId=w.id;
  const info=safeParse(w.info);
  exercise.value=info.exercise;
  sets=info.sets||[];
  setsDiv.innerHTML="";
  sets.forEach(s=>addSet(s.weight,s.reps));
  showModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ");
}
function showModal(t){ modalTitle.innerText=t; modal.style.display="flex"; }
function closeModal(){ modal.style.display="none"; }

function addSet(weight="",reps=""){
  const i=sets.length;
  sets.push({weight,reps});
  const d=document.createElement("div");
  d.className="set";
  d.innerHTML=`
    <input type="number" placeholder="–∫–≥" value="${weight}" onchange="sets[${i}].weight=this.value">
    <input type="number" placeholder="—Ä–∞–∑" value="${reps}" onchange="sets[${i}].reps=this.value">
    <button class="danger" onclick="this.parentElement.remove()">‚úñ</button>
  `;
  setsDiv.appendChild(d);
}

async function saveWorkout(){
  const body={
    workout_date:new Date().toISOString(),
    info:JSON.stringify({exercise:exercise.value,sets})
  };

  if(currentWorkoutId){
    await fetch(`${API}/workouts/${currentWorkoutId}`,{
      method:"PUT",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
  }else{
    await fetch(`${API}/workouts/${telegramId}`,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
  }
  closeModal();
  loadHistory();
}

async function deleteWorkout(id){
  await fetch(`${API}/workouts/${id}`,{method:"DELETE"});
  loadHistory();
}

async function loadHistory(){
  const r=await fetch(`${API}/workouts/${telegramId}`);
  const data=await r.json();
  history.innerHTML="";
  data.forEach(w=>{
    const info=safeParse(w.info);
    if(!info)return;
    history.innerHTML+=`
      <div class="card">
        <b>${info.exercise}</b><br>
        ${info.sets.map(s=>`${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")}
        <br>
        <button onclick='openEdit(${JSON.stringify(w)})'>‚úèÔ∏è</button>
        <button class="danger" onclick='deleteWorkout(${w.id})'>üóë</button>
      </div>`;
  });
}

loadHistory();
</script>

</body>
</html>
