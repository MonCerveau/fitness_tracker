<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Тренировки</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }
body { margin: 0; background: #0f0f0f; color: #fff; }

header {
  padding: 16px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
  border-bottom: 1px solid #222;
}

#content { padding: 12px; }

.workout {
  background: #1e1e1e;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
}

.exercise { margin-top: 6px; font-size: 14px; }
.set { color: #aaa; margin-left: 10px; }

button {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 10px;
  width: 100%;
  margin-top: 8px;
}

button.secondary { background: #333; }
button.danger { background: #b91c1c; }

.fab {
  position: fixed;
  right: 16px;
  bottom: 16px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  font-size: 24px;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  justify-content: center;
  align-items: center;
}

.modal.open { display: flex; }

.modal-content {
  background: #121212;
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 16px;
  padding: 16px;
}

input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: none;
  margin-bottom: 6px;
}

.row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.row input { flex: 1; }

.small {
  width: 36px;
  height: 36px;
  padding: 0;
}
</style>
</head>

<body>

<header>Тренировки</header>

<div id="content"></div>

<button class="fab" id="addBtn">+</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Новая тренировка</h3>

    <input type="date" id="date">

    <div id="exercises"></div>

    <button onclick="addExercise()">Добавить упражнение</button>

    <button id="saveBtn">Сохранить</button>
    <button class="secondary" onclick="closeModal()">Отмена</button>
  </div>
</div>

<script>
const API = 'https://ula-conductorial-vagrantly.ngrok-free.dev';
const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 505375162;

let workouts = [];
let editingId = null;

/* ===== LOAD ===== */
async function loadWorkouts() {
  const res = await fetch(`${API}/workouts/${telegramId}`);
  workouts = await res.json();
  render();
}

function render() {
  const box = document.getElementById('content');
  box.innerHTML = '';

  workouts.forEach(w => {
    const d = document.createElement('div');
    d.className = 'workout';
    d.innerHTML = `<b>${w.workout_date}</b>`;

    w.info.exercises.forEach(e => {
      const ex = document.createElement('div');
      ex.className = 'exercise';
      ex.innerHTML = `<div><b>${e.name}</b></div>`;
      e.sets.forEach(s => {
        const st = document.createElement('div');
        st.className = 'set';
        st.innerText = `${s.weight} кг × ${s.reps}`;
        ex.appendChild(st);
      });
      d.appendChild(ex);
    });

    const edit = document.createElement('button');
    edit.innerText = 'Редактировать';
    edit.onclick = () => openModal(w);

    const del = document.createElement('button');
    del.innerText = 'Удалить';
    del.className = 'danger';
    del.onclick = () => deleteWorkout(w.id);

    d.appendChild(edit);
    d.appendChild(del);

    box.appendChild(d);
  });
}

/* ===== MODAL ===== */
document.getElementById('addBtn').onclick = () => openModal();

function openModal(w=null) {
  editingId = w?.id || null;
  document.getElementById('modalTitle').innerText =
    editingId ? 'Редактирование' : 'Новая тренировка';

  document.getElementById('date').value = w?.workout_date || '';
  document.getElementById('exercises').innerHTML = '';

  w?.info.exercises.forEach(addExerciseFromData);

  document.getElementById('modal').classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

/* ===== EXERCISES ===== */
function addExerciseFromData(e) {
  const wrap = document.createElement('div');
  wrap.innerHTML = `<input value="${e.name}">`;
  e.sets.forEach(s => addSet(wrap, s));
  wrap.appendChild(btn('Добавить подход', () => addSet(wrap)));
  document.getElementById('exercises').appendChild(wrap);
}

function addExercise() {
  addExerciseFromData({ name:'', sets:[] });
}

function addSet(wrap, s={}) {
  const r = document.createElement('div');
  r.className = 'row';
  r.innerHTML = `
    <input placeholder="кг" value="${s.weight||''}">
    <input placeholder="повт" value="${s.reps||''}">
  `;
  r.appendChild(btn('×', ()=>r.remove(),'small danger'));
  wrap.insertBefore(r, wrap.lastChild);
}

/* ===== SAVE ===== */
document.getElementById('saveBtn').onclick = async () => {
  const date = document.getElementById('date').value;
  if (!date) return alert('Выбери дату');

  const exercises = [];
  document.querySelectorAll('#exercises > div').forEach(ex => {
    const name = ex.querySelector('input').value;
    const sets = [];
    ex.querySelectorAll('.row').forEach(r => {
      const i = r.querySelectorAll('input');
      sets.push({ weight:+i[0].value, reps:+i[1].value });
    });
    if (name && sets.length) exercises.push({ name, sets });
  });

  const payload = { workout_date: date, info:{exercises} };
  const url = editingId
    ? `${API}/workouts/${editingId}`
    : `${API}/workouts/${telegramId}`;

  await fetch(url, {
    method: editingId ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  closeModal();
  loadWorkouts();
};

async function deleteWorkout(id) {
  if (!confirm('Удалить тренировку?')) return;
  await fetch(`${API}/workouts/${id}`, { method:'DELETE' });
  loadWorkouts();
}

function btn(t,fn,cls='') {
  const b=document.createElement('button');
  b.innerText=t;b.className=cls;b.onclick=fn;return b;
}

loadWorkouts();
</script>
</body>
</html>
