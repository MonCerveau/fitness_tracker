<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { font-family: Arial; padding: 16px; }
button { margin: 4px; }
.workout { border: 1px solid #ccc; padding: 8px; margin: 6px 0; }
.modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.4);
    display: none; align-items: center; justify-content: center;
}
.modal-content {
    background: #fff; padding: 16px; width: 300px;
}
.set { display: flex; gap: 4px; margin-bottom: 4px; }
</style>
</head>
<body>

<h3>üë§ Telegram ID</h3>
<div id="userId"></div>

<button onclick="openAddModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
<div id="history"></div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
<div class="modal" id="modal">
<div class="modal-content">
    <h4 id="modalTitle"></h4>

    <input id="exercise" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"><br><br>

    <div id="sets"></div>
    <button onclick="addSet()">‚ûï –ü–æ–¥—Ö–æ–¥</button><br><br>

    <button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
</div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const userId = tg.initDataUnsafe.user.id;
document.getElementById("userId").innerText = userId;

let currentWorkoutId = null;
let sets = [];

function safeParse(json) {
    try { return JSON.parse(json); } catch { return null; }
}

function openAddModal() {
    currentWorkoutId = null;
    sets = [];
    document.getElementById("exercise").value = "";
    document.getElementById("sets").innerHTML = "";
    addSet();
    showModal("–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞");
}

function openEditModal(workout) {
    currentWorkoutId = workout.id;
    const info = safeParse(workout.info);
    if (!info) return;

    sets = info.sets || [];
    document.getElementById("exercise").value = info.exercise;
    document.getElementById("sets").innerHTML = "";
    sets.forEach((s, i) => addSet(s.weight, s.reps, i));
    showModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ");
}

function showModal(title) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modal").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

function addSet(weight="", reps="", index=null) {
    if (index === null) {
        index = sets.length;
        sets.push({weight, reps});
    }
    const div = document.createElement("div");
    div.className = "set";
    div.innerHTML = `
        <input type="number" value="${weight}" placeholder="–∫–≥"
            onchange="sets[${index}].weight=this.value">
        <input type="number" value="${reps}" placeholder="—Ä–∞–∑"
            onchange="sets[${index}].reps=this.value">
        <button onclick="removeSet(${index}, this)">‚ùå</button>
    `;
    document.getElementById("sets").appendChild(div);
}

function removeSet(index, btn) {
    sets[index] = null;
    btn.parentElement.remove();
}

async function saveWorkout() {
    const exercise = document.getElementById("exercise").value;
    const payload = {
        exercise,
        sets: sets.filter(Boolean)
    };

    const body = {
        workout_type_id: 1,
        workout_date: new Date().toISOString(),
        info: JSON.stringify(payload)
    };

    if (currentWorkoutId) {
        await fetch(`${API_URL}/workouts/${currentWorkoutId}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });
    } else {
        await fetch(`${API_URL}/workouts/${userId}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });
    }

    closeModal();
    loadHistory();
}

async function deleteWorkout(id) {
    await fetch(`${API_URL}/workouts/${id}`, { method: "DELETE" });
    loadHistory();
}

async function loadHistory() {
    const res = await fetch(`${API_URL}/workouts/${userId}`);
    const data = await res.json();
    const history = document.getElementById("history");
    history.innerHTML = "";

    data.forEach(w => {
        const info = safeParse(w.info);
        if (!info) return;

        const div = document.createElement("div");
        div.className = "workout";
        div.innerHTML = `
            <b>${info.exercise}</b><br>
            ${info.sets.map(s => `${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")}
            <br>
            <button onclick='openEditModal(${JSON.stringify(w)})'>‚úèÔ∏è</button>
            <button onclick='deleteWorkout(${w.id})'>üóë</button>
        `;
        history.appendChild(div);
    });
}

loadHistory();
</script>

</body>
</html>
    
