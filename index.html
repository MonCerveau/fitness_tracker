<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout MiniApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
}
header {
  padding: 12px;
  background: #2a8cff;
  color: #fff;
  text-align: center;
  font-weight: 600;
}
.container {
  padding: 12px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
}
.exercise {
  font-weight: 600;
  margin-top: 6px;
}
.set {
  font-size: 14px;
  margin-left: 10px;
}
button {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  margin-top: 8px;
  font-size: 16px;
}
.primary { background: #2a8cff; color: #fff; }
.danger { background: #ff4d4f; color: #fff; }
.secondary { background: #e0e0e0; }
input {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  font-size: 16px;
}
hr { margin: 10px 0; }
</style>
</head>

<body>
<header>Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸</header>
<div class="container" id="app"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe?.user?.id;
const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev";

/* ===== STATE ===== */
const state = {
  screen: "history",
  workouts: [],
  draft: { exercises: [] },
  editWorkoutId: null
};

/* ===== API ===== */
async function apiGetWorkouts() {
  const r = await fetch(`${API_URL}/workouts/${telegramId}`);
  return r.json();
}

async function apiSaveWorkout() {
  return fetch(`${API_URL}/workouts/${telegramId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      workout_date: new Date().toISOString(),
      info: state.draft
    })
  });
}

async function apiDeleteWorkout(id) {
  return fetch(`${API_URL}/workouts/${id}`, { method: "DELETE" });
}

/* ===== RENDER ===== */
function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  if (state.screen === "history") renderHistory(app);
  if (state.screen === "form") renderForm(app);
}

function renderHistory(app) {
  const addBtn = document.createElement("button");
  addBtn.className = "primary";
  addBtn.innerText = "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ";
  addBtn.onclick = () => {
    state.draft = { exercises: [] };
    state.screen = "form";
    render();
  };
  app.appendChild(addBtn);

  state.workouts.forEach(w => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `<div>ðŸ“… ${w.workout_date}</div>`;

    w.info.exercises.forEach(ex => {
      card.innerHTML += `<div class="exercise">${ex.name}</div>`;
      ex.sets.forEach(s => {
        card.innerHTML += `<div class="set">${s.weight} ÐºÐ³ Ã— ${s.reps}</div>`;
      });
    });

    const del = document.createElement("button");
    del.className = "danger";
    del.innerText = "ðŸ—‘ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ";
    del.onclick = async () => {
      await apiDeleteWorkout(w.id);
      await loadHistory();
    };

    card.appendChild(del);
    app.appendChild(card);
  });
}

function renderForm(app) {
  const card = document.createElement("div");
  card.className = "card";

  state.draft.exercises.forEach((ex, exIdx) => {
    card.innerHTML += `<div class="exercise">${ex.name}</div>`;
    ex.sets.forEach(s => {
      card.innerHTML += `<div class="set">${s.weight} ÐºÐ³ Ã— ${s.reps}</div>`;
    });
  });

  const exName = document.createElement("input");
  exName.placeholder = "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ";

  const weight = document.createElement("input");
  weight.placeholder = "Ð’ÐµÑ";
  weight.type = "number";

  const reps = document.createElement("input");
  reps.placeholder = "ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ñ‹";
  reps.type = "number";

  const addSet = document.createElement("button");
  addSet.className = "secondary";
  addSet.innerText = "Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´";
  addSet.onclick = () => {
    let ex = state.draft.exercises.find(e => e.name === exName.value);
    if (!ex) {
      ex = { name: exName.value, sets: [] };
      state.draft.exercises.push(ex);
    }
    ex.sets.push({ weight: +weight.value, reps: +reps.value });
    render();
  };

  const save = document.createElement("button");
  save.className = "primary";
  save.innerText = "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ";
  save.onclick = async () => {
    await apiSaveWorkout();
    state.screen = "history";
    await loadHistory();
  };

  const cancel = document.createElement("button");
  cancel.className = "secondary";
  cancel.innerText = "ÐÐ°Ð·Ð°Ð´";
  cancel.onclick = () => {
    state.screen = "history";
    render();
  };

  app.append(card, exName, weight, reps, addSet, save, cancel);
}

/* ===== INIT ===== */
async function loadHistory() {
  state.workouts = await apiGetWorkouts();
  render();
}

loadHistory();
</script>
</body>
</html>
