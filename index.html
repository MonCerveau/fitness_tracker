<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; padding: 16px; }
        input, button { margin: 4px 0; }
        .set { margin-left: 12px; }
        .workout { border: 1px solid #ccc; padding: 8px; margin-top: 8px; }
    </style>
</head>
<body>

<h3>üë§ Telegram ID</h3>
<div id="userId">‚Äî</div>

<hr>

<h3>‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>

<input id="exercise" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"><br>

<div id="sets"></div>
<button onclick="addSet()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button><br><br>

<button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<hr>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
<div id="history"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const API_URL = "https://fitness-tracker-backend-ef0q.onrender.com";
const userId = tg.initDataUnsafe.user.id;

document.getElementById("userId").innerText = userId;

let sets = [];

function addSet(weight = "", reps = "") {
    const index = sets.length;
    sets.push({ weight, reps });

    const div = document.createElement("div");
    div.className = "set";
    div.id = `set-${index}`;
    div.innerHTML = `
        –í–µ—Å: <input type="number" value="${weight}" onchange="sets[${index}].weight=this.value">
        –ü–æ–≤—Ç–æ—Ä—ã: <input type="number" value="${reps}" onchange="sets[${index}].reps=this.value">
        <button onclick="removeSet(${index})">‚ùå</button>
    `;
    document.getElementById("sets").appendChild(div);
}

function removeSet(index) {
    sets[index] = null;
    document.getElementById(`set-${index}`).remove();
}

async function saveWorkout() {
    const exercise = document.getElementById("exercise").value;
    const filteredSets = sets.filter(s => s);

    if (!exercise || filteredSets.length === 0) {
        alert("–ó–∞–ø–æ–ª–Ω–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –ø–æ–¥—Ö–æ–¥—ã");
        return;
    }

    const payload = {
        exercise,
        sets: filteredSets
    };

    await fetch(`${API_URL}/workouts/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            workout_type_id: 1,
            workout_date: new Date().toISOString(),
            info: JSON.stringify(payload)
        })
    });

    document.getElementById("exercise").value = "";
    document.getElementById("sets").innerHTML = "";
    sets = [];

    loadHistory();
}

async function loadHistory() {
    const res = await fetch(`${API_URL}/workouts/${userId}`);
    const data = await res.json();

    const history = document.getElementById("history");
    history.innerHTML = "";

    data.forEach(w => {
        const info = JSON.parse(w.info);
        const div = document.createElement("div");
        div.className = "workout";

        div.innerHTML = `
            <b>${new Date(w.workout_date).toLocaleDateString()}</b><br>
            üèãÔ∏è ${info.exercise}<br>
            ${info.sets.map(s => `‚Ä¢ ${s.weight} –∫–≥ √ó ${s.reps}`).join("<br>")}
            <br><button onclick="deleteWorkout(${w.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
        `;

        history.appendChild(div);
    });
}

async function deleteWorkout(id) {
    await fetch(`${API_URL}/workouts/${id}`, { method: "DELETE" });
    loadHistory();
}

addSet();
loadHistory();
</script>

</body>
</html>
