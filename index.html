<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Workout Diary</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  font-family: system-ui;
  background: #f2f2f2;
  padding: 12px;
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
}

button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
}

.primary { background: #2a8cff; color: #fff; }
.secondary { background: #888; color: #fff; }
.danger { background: #e74c3c; color: #fff; }

input {
  width: 100%;
  padding: 6px;
  margin-bottom: 6px;
  font-size: 14px;
}

.exercise {
  border-top: 1px solid #ddd;
  padding-top: 8px;
  margin-top: 8px;
}

.set {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<h3 id="uid"></h3>
<button class="primary" onclick="openCreate()">‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>

<div id="history"></div>

<!-- MODAL -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4)">
  <div style="background:#fff; padding:16px; border-radius:12px; margin:8% auto; width:95%; max-width:380px">
    <h4>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h4>

    <div id="exercises"></div>

    <button class="secondary" onclick="addExercise()">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button><br><br>

    <button class="primary" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev; // ‚Üê –ó–ê–ú–ï–ù–ò
const tg = Telegram.WebApp;
tg.ready();

/* ================== STATE ================== */
const telegramId = tg.initDataUnsafe.user.id;
uid.innerText = `Telegram ID: ${telegramId}`;

let currentWorkoutId = null;
let workoutExercises = [];

/* ================== MODAL ================== */
function openCreate() {
  currentWorkoutId = null;
  workoutExercises = [];
  exercises.innerHTML = "";
  addExercise();
  modal.style.display = "block";
}

function closeModal() {
  modal.style.display = "none";
}

/* ================== EXERCISES ================== */
function addExercise(data = { name: "", sets: [] }) {
  const exIndex = workoutExercises.length;
  workoutExercises.push(data);

  const block = document.createElement("div");
  block.className = "exercise";

  block.innerHTML = `
    <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
    <div class="sets"></div>
    <button class="secondary">‚ûï –ü–æ–¥—Ö–æ–¥</button>
  `;

  const nameInput = block.querySelector("input");
  const setsDiv = block.querySelector(".sets");
  const addSetBtn = block.querySelector("button");

  nameInput.value = data.name;
  nameInput.oninput = e => workoutExercises[exIndex].name = e.target.value;

  addSetBtn.onclick = () => addSet(exIndex, setsDiv);

  exercises.appendChild(block);
}

function addSet(exIndex, container) {
  const set = { weight: 0, reps: 0 };
  workoutExercises[exIndex].sets.push(set);

  const row = document.createElement("div");
  row.className = "set";

  row.innerHTML = `
    <input type="number" placeholder="–∫–≥">
    <input type="number" placeholder="—Ä–∞–∑">
    <button class="danger">‚úñ</button>
  `;

  row.children[0].oninput = e => set.weight = Number(e.target.value);
  row.children[1].oninput = e => set.reps = Number(e.target.value);
  row.children[2].onclick = () => {
    workoutExercises[exIndex].sets =
      workoutExercises[exIndex].sets.filter(s => s !== set);
    row.remove();
  };

  container.appendChild(row);
}

/* ================== SAVE ================== */
async function saveWorkout() {
  const info = {
    exercises: workoutExercises
      .filter(e => e.name && e.sets.length)
      .map(e => ({
        name: e.name,
        sets: e.sets.filter(s => s.weight > 0 && s.reps > 0)
      }))
  };

  if (!info.exercises.length) {
    alert("–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ");
    return;
  }

  const url = currentWorkoutId
    ? `${API}/workouts/${currentWorkoutId}`
    : `${API}/workouts/${telegramId}`;

  await fetch(url, {
    method: currentWorkoutId ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      workout_date: new Date().toISOString(),
      info
    })
  });

  closeModal();
  loadHistory();
}

/* ================== HISTORY ================== */
async function deleteWorkout(id) {
  await fetch(`${API}/workouts/${id}`, { method: "DELETE" });
  loadHistory();
}

async function loadHistory() {
  const r = await fetch(`${API}/workouts/${telegramId}`);
  const data = await r.json();

  history.innerHTML = "";

  data.forEach(w => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      ${w.info.exercises.map(ex => `
        <b>${ex.name}</b><br>
        ${ex.sets.map(s => `${s.weight} –∫–≥ √ó ${s.reps}`).join("<br>")}
      `).join("<hr>")}
      <br>
      <button class="danger" onclick="deleteWorkout(${w.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
    `;

    history.appendChild(card);
  });
}

loadHistory();
</script>

</body>
</html>
