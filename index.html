<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout MiniApp</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
  padding: 10px;
}

button {
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  margin-top: 6px;
}

.primary { background:#2a8cff; color:#fff; }
.secondary { background:#888; color:#fff; }
.danger { background:#e74c3c; color:#fff; }

.card {
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}

input {
  width:100%;
  padding:8px;
  margin-bottom:6px;
  font-size:15px;
}

.row {
  display:flex;
  gap:6px;
  align-items:center;
}

.row input { flex:1; }
.row button {
  flex:0 0 36px;
  height:36px;
  padding:0;
}

.hidden { display:none; }
.exercise { border-top:1px solid #ddd; margin-top:8px; padding-top:8px; }
.small { font-size:13px; color:#555; }
</style>
</head>

<body>

<div id="listView">
  <button class="primary" onclick="openEditor()">‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
  <div id="history"></div>
</div>

<div id="editorView" class="hidden">
  <div class="card">
    <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
    <div id="exercises"></div>
    <button class="secondary" onclick="addExercise()">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
    <button class="primary" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeEditor()">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>
</div>

<script>
const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;

let workouts = [];
let currentWorkoutId = null;
let exercisesData = [];

/* ---------- VIEW ---------- */
function openEditor(workout=null){
  listView.classList.add("hidden");
  editorView.classList.remove("hidden");
  exercises.innerHTML="";
  exercisesData=[];
  currentWorkoutId = workout?.id ?? null;

  if(workout){
    workout.info.exercises.forEach(e=>addExercise(e));
  } else addExercise();
}

function closeEditor(){
  editorView.classList.add("hidden");
  listView.classList.remove("hidden");
}

/* ---------- EXERCISES ---------- */
function addExercise(data={name:"",sets:[]}) {
  const ex = { name:data.name, sets:[...data.sets] };
  exercisesData.push(ex);

  const block = document.createElement("div");
  block.className="exercise";

  const name = document.createElement("input");
  name.placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è";
  name.value=ex.name;
  name.oninput=e=>ex.name=e.target.value;

  const setsDiv = document.createElement("div");

  const addSetBtn = document.createElement("button");
  addSetBtn.className="secondary";
  addSetBtn.innerText="‚ûï –ü–æ–¥—Ö–æ–¥";
  addSetBtn.onclick=()=>addSet(ex,setsDiv);

  block.append(name,setsDiv,addSetBtn);
  exercises.appendChild(block);

  ex.sets.forEach(s=>addSet(ex,setsDiv,s));
}

function addSet(ex,container,data={weight:0,reps:0}) {
  const set={...data};
  ex.sets.push(set);

  const row=document.createElement("div");
  row.className="row";

  const w=document.createElement("input");
  w.type="number"; w.placeholder="–∫–≥"; w.value=set.weight;
  w.oninput=e=>set.weight=+e.target.value;

  const r=document.createElement("input");
  r.type="number"; r.placeholder="—Ä–∞–∑"; r.value=set.reps;
  r.oninput=e=>set.reps=+e.target.value;

  const del=document.createElement("button");
  del.className="danger"; del.innerText="‚úñ";
  del.onclick=()=>{
    ex.sets=ex.sets.filter(s=>s!==set);
    row.remove();
  };

  row.append(w,r,del);
  container.appendChild(row);
}

/* ---------- SAVE ---------- */
async function saveWorkout(){
  const payload={
    workout_date:new Date().toISOString(),
    info:{
      exercises:exercisesData
        .filter(e=>e.name && e.sets.length)
        .map(e=>({
          name:e.name,
          sets:e.sets.filter(s=>s.weight>0 && s.reps>0)
        }))
    }
  };

  if(!payload.info.exercises.length){
    alert("–î–æ–±–∞–≤—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ");
    return;
  }

  const url=currentWorkoutId
    ? `${API_URL}/workouts/${currentWorkoutId}`
    : `${API_URL}/workouts/${telegramId}`;

  await fetch(url,{
    method:currentWorkoutId?"PUT":"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  closeEditor();
  loadHistory();
}

/* ---------- HISTORY ---------- */
async function loadHistory(){
  const r=await fetch(`${API_URL}/workouts/${telegramId}`);
  workouts=await r.json();

  history.innerHTML="";

  workouts.forEach(w=>{
    if(!w.info || !w.info.exercises) return;

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <b>${new Date(w.workout_date).toLocaleDateString()}</b>
      <div class="small">
        ${w.info.exercises.map(e=>`
          ${e.name}: ${e.sets.map(s=>`${s.weight}√ó${s.reps}`).join(", ")}
        `).join("<br>")}
      </div>
      <button class="secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
    `;

    card.children[2].onclick=()=>openEditor(w);
    card.children[3].onclick=()=>deleteWorkout(w.id);

    history.appendChild(card);
  });
}

async function deleteWorkout(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?")) return;
  await fetch(`${API_URL}/workouts/${id}`,{method:"DELETE"});
  loadHistory();
}

loadHistory();
</script>
</body>
</html>

