<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Workout Diary</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { font-family: system-ui; background:#f2f2f2; padding:12px }
.card { background:#fff; padding:12px; border-radius:10px; margin-bottom:10px }
button { padding:6px 10px; border:none; border-radius:6px; }
.primary { background:#2a8cff; color:#fff }
.danger { background:#e74c3c; color:#fff }
input { width:100%; margin:4px 0 }
.set { display:flex; gap:4px }
</style>
</head>

<body>

<h3 id="uid"></h3>
<button class="primary" id="addBtn">➕ Добавить</button>

<div id="history"></div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;
document.getElementById("uid").innerText = `ID: ${telegramId}`;

async function loadHistory() {
  const r = await fetch(`${API}/workouts/${telegramId}`);
  const data = await r.json();
  history.innerHTML = "";

  data.forEach(w => {
    const { exercise, sets } = w.info;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${exercise}</b><br>
      ${sets.map(s => `${s.weight}кг × ${s.reps}`).join("<br>")}
      <br><br>
      <button class="danger">Удалить</button>
    `;
    div.querySelector("button").onclick = async () => {
      await fetch(`${API}/workouts/${w.id}`, { method:"DELETE" });
      loadHistory();
    };
    history.appendChild(div);
  });
}

document.getElementById("addBtn").onclick = async () => {
  const exercise = prompt("Название упражнения");
  if (!exercise) return;

  const sets = [];
  while (true) {
    const weight = prompt("Вес (отмена — закончить)");
    if (!weight) break;
    const reps = prompt("Повторы");
    sets.push({ weight:Number(weight), reps:Number(reps) });
  }

  await fetch(`${API}/workouts/${telegramId}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      workout_date:new Date().toISOString(),
      info:{ exercise, sets }
    })
  });

  loadHistory();
};

loadHistory();
</script>
</body>
</html>
