<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout MiniApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
}
header {
  padding: 12px;
  background: #2a8cff;
  color: #fff;
  text-align: center;
  font-weight: 600;
}
.container {
  padding: 12px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
}
.exercise {
  font-weight: 600;
  margin-top: 6px;
}
.set {
  font-size: 14px;
  margin-left: 10px;
}
button {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  margin-top: 8px;
  font-size: 16px;
}
.primary { background: #2a8cff; color: #fff; }
.secondary { background: #e0e0e0; }
.danger { background: #ff4d4f; color: #fff; }
input {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  font-size: 16px;
}
.notice {
  background: #fff3cd;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
  font-size: 14px;
}
</style>
</head>

<body>
<header>Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸</header>
<div class="container" id="app"></div>

<script>
/* ===== INIT TELEGRAM ===== */
let telegramId = null;

if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
  telegramId = Telegram.WebApp.initDataUnsafe.user.id;
} else {
  console.warn("Telegram user not found");
}

/* ===== CONFIG ===== */
const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev";

/* ===== STATE ===== */
const state = {
  screen: "history",
  workouts: [],
  draft: { exercises: [] }
};

/* ===== API ===== */
async function apiGetWorkouts() {
  if (!telegramId) return [];
  const r = await fetch(`${API_URL}/workouts/${telegramId}`);
  return r.json();
}

async function apiSaveWorkout() {
  if (!telegramId) return;

  await fetch(`${API_URL}/workouts/${telegramId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      workout_date: new Date().toISOString(),
      info: state.draft
    })
  });
}

/* ===== RENDER ===== */
function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  if (!telegramId) {
    const warn = document.createElement("div");
    warn.className = "notice";
    warn.innerText =
      "âš ï¸ Telegram ID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐžÑ‚ÐºÑ€Ð¾Ð¹ MiniApp Ñ‡ÐµÑ€ÐµÐ· Telegram-Ð±Ð¾Ñ‚Ð°.";
    app.appendChild(warn);
  }

  if (state.screen === "history") renderHistory(app);
  if (state.screen === "form") renderForm(app);
}

function renderHistory(app) {
  const addBtn = document.createElement("button");
  addBtn.className = "primary";
  addBtn.innerText = "âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ";
  addBtn.onclick = () => {
    state.draft = { exercises: [] };
    state.screen = "form";
    render();
  };
  app.appendChild(addBtn);

  state.workouts.forEach(w => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `<div>ðŸ“… ${w.workout_date}</div>`;

    w.info.exercises.forEach(ex => {
      card.innerHTML += `<div class="exercise">${ex.name}</div>`;
      ex.sets.forEach(s => {
        card.innerHTML += `<div class="set">${s.weight} ÐºÐ³ Ã— ${s.reps}</div>`;
      });
    });

    app.appendChild(card);
  });
}

function renderForm(app) {
  const card = document.createElement("div");
  card.className = "card";

  state.draft.exercises.forEach(ex => {
    card.innerHTML += `<div class="exercise">${ex.name}</div>`;
    ex.sets.forEach(s => {
      card.innerHTML += `<div class="set">${s.weight} ÐºÐ³ Ã— ${s.reps}</div>`;
    });
  });

  const name = document.createElement("input");
  name.placeholder = "Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ";

  const weight = document.createElement("input");
  weight.type = "number";
  weight.placeholder = "Ð’ÐµÑ";

  const reps = document.createElement("input");
  reps.type = "number";
  reps.placeholder = "ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ñ‹";

  const addSet = document.createElement("button");
  addSet.className = "secondary";
  addSet.innerText = "Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´";
  addSet.onclick = () => {
    if (!name.value) return;
    let ex = state.draft.exercises.find(e => e.name === name.value);
    if (!ex) {
      ex = { name: name.value, sets: [] };
      state.draft.exercises.push(ex);
    }
    ex.sets.push({ weight: +weight.value, reps: +reps.value });
    render();
  };

  const save = document.createElement("button");
  save.className = "primary";
  save.innerText = "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ";
  save.onclick = async () => {
    await apiSaveWorkout();
    state.screen = "history";
    await loadHistory();
  };

  const back = document.createElement("button");
  back.className = "secondary";
  back.innerText = "ÐÐ°Ð·Ð°Ð´";
  back.onclick = () => {
    state.screen = "history";
    render();
  };

  app.append(card, name, weight, reps, addSet, save, back);
}

/* ===== LOAD ===== */
async function loadHistory() {
  try {
    state.workouts = await apiGetWorkouts();
  } catch (e) {
    console.error(e);
    state.workouts = [];
  }
  render();
}

loadHistory();
</script>
</body>
</html>
