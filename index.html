<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Workout Diary</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { font-family: system-ui; background:#f2f2f2; padding:12px }
.card { background:#fff; padding:12px; border-radius:10px; margin-bottom:10px }
button { padding:6px 10px; border-radius:6px; border:none }
.primary { background:#2a8cff; color:#fff }
.danger { background:#e74c3c; color:#fff }
.secondary { background:#999; color:#fff }
input { width:100%; padding:6px; margin-bottom:6px }
.set { display:flex; gap:6px; margin-bottom:6px }
.set input { width:45% }
</style>
</head>

<body>

<h3 id="uid"></h3>
<button class="primary" onclick="openCreate()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<div id="history"></div>

<!-- MODAL -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4)">
  <div style="background:#fff; padding:16px; border-radius:12px; margin:10% auto; width:90%; max-width:320px">
    <h4 id="modalTitle"></h4>
    <input id="exerciseInput" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
    <div id="sets"></div>
    <button class="secondary" onclick="addSet()">‚ûï –ü–æ–¥—Ö–æ–¥</button><br><br>
    <button class="primary" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const tg = Telegram.WebApp;
tg.ready();

const telegramId = tg.initDataUnsafe.user.id;
uid.innerText = `Telegram ID: ${telegramId}`;

let currentWorkoutId = null;
let currentSets = [];

function openCreate() {
  currentWorkoutId = null;
  exerciseInput.value = "";
  currentSets = [];
  sets.innerHTML = "";
  addSet();
  openModal("–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞");
}

function openEdit(workout) {
  currentWorkoutId = workout.id;
  exerciseInput.value = workout.info.exercise;
  currentSets = workout.info.sets || [];
  sets.innerHTML = "";
  currentSets.forEach(s => addSet(s.weight, s.reps));
  openModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ");
}

function addSet(weight = "", reps = "") {
  const index = currentSets.length;
  currentSets.push({ weight, reps });

  const div = document.createElement("div");
  div.className = "set";
  div.innerHTML = `
    <input type="number" placeholder="–∫–≥" value="${weight}">
    <input type="number" placeholder="—Ä–∞–∑" value="${reps}">
    <button class="danger">‚úñ</button>
  `;

  div.children[0].oninput = e => currentSets[index].weight = Number(e.target.value);
  div.children[1].oninput = e => currentSets[index].reps = Number(e.target.value);
  div.children[2].onclick = () => {
    currentSets.splice(index, 1);
    div.remove();
  };

  sets.appendChild(div);
}

function openModal(title) {
  modalTitle.innerText = title;
  modal.style.display = "block";
}

function closeModal() {
  modal.style.display = "none";
}

async function saveWorkout() {
  const body = {
    workout_date: new Date().toISOString(),
    info: {
      exercise: exerciseInput.value,
      sets: currentSets.filter(s => s.weight && s.reps)
    }
  };

  const url = currentWorkoutId
    ? `${API}/workouts/${currentWorkoutId}`
    : `${API}/workouts/${telegramId}`;

  await fetch(url, {
    method: currentWorkoutId ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  closeModal();
  loadHistory();
}

async function deleteWorkout(id) {
  await fetch(`${API}/workouts/${id}`, { method:"DELETE" });
  loadHistory();
}

async function loadHistory() {
  const r = await fetch(`${API}/workouts/${telegramId}`);
  const data = await r.json();

  history.innerHTML = "";
  data.forEach(w => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <b>${w.info.exercise}</b><br>
      ${w.info.sets.map(s => `${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")}
      <br><br>
      <button onclick='openEdit(${JSON.stringify(w)})'>‚úèÔ∏è</button>
      <button class="danger" onclick='deleteWorkout(${w.id})'>üóë</button>
    `;
    history.appendChild(c);
  });
}

loadHistory();
</script>
</body>
</html>
