<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  font-family: system-ui;
  background: #f5f5f5;
  margin: 0;
  padding: 16px;
}
.card {
  background: #fff;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
}
button {
  padding: 6px 10px;
  border: none;
  border-radius: 8px;
  background: #2a8cff;
  color: white;
}
button.danger { background: #e74c3c; }
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: white;
  padding: 16px;
  width: 90%;
  max-width: 320px;
  border-radius: 12px;
}
input {
  width: 100%;
  margin-bottom: 8px;
  padding: 6px;
}
</style>
</head>

<body>

<h3>üë§ Telegram ID</h3>
<div class="card" id="uid"></div>

<button onclick="openModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è</h3>
<div id="history"></div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h4>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h4>
    <input id="exercise" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
    <input id="weight" type="number" placeholder="–í–µ—Å (–∫–≥)">
    <input id="reps" type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã">
    <button onclick="saveWorkout()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const telegramId = tg.initDataUnsafe.user.id;
document.getElementById("uid").innerText = telegramId;

function openModal() {
  document.getElementById("modal").style.display = "flex";
}
function closeModal() {
  document.getElementById("modal").style.display = "none";
}

async function saveWorkout() {
  const payload = {
    exercise: exercise.value,
    sets: [{ weight: weight.value, reps: reps.value }]
  };

  await fetch(`${API}/workouts/${telegramId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ info: JSON.stringify(payload) })
  });

  closeModal();
  loadHistory();
}

async function deleteWorkout(id) {
  await fetch(`${API}/workouts/${id}`, { method: "DELETE" });
  loadHistory();
}

async function loadHistory() {
  const res = await fetch(`${API}/workouts/${telegramId}`);
  const data = await res.json();

  const root = document.getElementById("history");
  root.innerHTML = "";

  data.forEach(w => {
    const info = JSON.parse(w.info);
    root.innerHTML += `
      <div class="card">
        <b>${info.exercise}</b><br>
        ${info.sets[0].weight} –∫–≥ √ó ${info.sets[0].reps}
        <br><br>
        <button class="danger" onclick="deleteWorkout(${w.id})">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
  });
}

loadHistory();
</script>
</body>
</html>
