<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* (–°–¢–ò–õ–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ‚Äî —Å–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏) */
:root { --bg:#0f172a; --card:#020617; --accent:#2563eb; --muted:#334155; --danger:#dc2626; }
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui;background:var(--bg);color:#e5e7eb}
button{border:none;border-radius:10px;padding:8px 10px;background:var(--accent);color:white}
.secondary{background:var(--muted)} .danger{background:var(--danger)}
.workout{background:var(--card);border-radius:14px;padding:12px;margin-bottom:10px}
.exercise{margin-top:8px;padding-top:6px;border-top:1px solid #1e293b}
.set{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:6px}
#fab{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:50%;font-size:28px}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
#modal.show{display:flex}
#modalContent{background:var(--card);width:100%;max-width:420px;border-radius:16px;padding:14px}
input{width:100%;padding:8px;border-radius:8px;border:none;margin-top:6px}
</style>
</head>

<body>

<h1>üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>

<div id="workouts"></div>

<button id="fab">+</button>

<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle"></h3>
    <input type="date" id="workoutDate">
    <div id="modalExercises"></div>

    <button id="addExerciseBtn">‚ûï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button><br><br>
    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="cancelBtn" class="secondary">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
const API = "https://ula-conductorial-vagrantly.ngrok-free.dev";
const telegramId = Telegram.WebApp.initDataUnsafe.user.id;

let workouts = [];
let editingId = null;

/* ===== LOAD ===== */
async function loadWorkouts(){
  const r = await fetch(`${API}/workouts/${telegramId}`, {
    headers:{ "ngrok-skip-browser-warning":"true" }
  });
  workouts = await r.json();
  render();
}

/* ===== RENDER ===== */
function render(){
  workouts.forEach(w=>{
    const c=document.createElement("div");
    c.className="workout";
    c.innerHTML=`<strong>${w.workout_date}</strong>`;
    w.info.exercises.forEach(ex=>{
      c.innerHTML+=`<div class="exercise"><b>${ex.name}</b><br>`+
        ex.sets.map(s=>`${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")+
      `</div>`;
    });
    workoutsEl.append(c);
  });
}

/* ===== MODAL ===== */
function openAdd(){
  editingId=null;
  modal.classList.add("show");
  modalExercises.innerHTML="";
  workoutDate.value=new Date().toISOString().slice(0,10);
}
function closeModal(){ modal.classList.remove("show"); }

function addExercise(){
  const e=document.createElement("div");
  e.className="exercise";
  e.innerHTML=`<input class="ex-name" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
    <div class="sets"></div>
    <button class="secondary">‚ûï –ü–æ–¥—Ö–æ–¥</button>`;
  e.querySelector("button").addEventListener("click",()=>addSet(e));
  modalExercises.append(e);
}

function addSet(ex){
  const s=document.createElement("div");
  s.className="set";
  s.innerHTML=`<input type="number" placeholder="–í–µ—Å">
    <input type="number" placeholder="–ü–æ–≤—Ç.">
    <button class="danger">‚úï</button>`;
  s.querySelector("button").addEventListener("click",()=>s.remove());
  ex.querySelector(".sets").append(s);
}

/* ===== SAVE ===== */
async function saveWorkout(){
  const exercises=[...document.querySelectorAll(".exercise")].map(ex=>({
    name:ex.querySelector(".ex-name").value,
    sets:[...ex.querySelectorAll(".set")].map(s=>({
      weight:+s.children[0].value,
      reps:+s.children[1].value
    }))
  }));

  await fetch(`${API}/workouts/${telegramId}`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "ngrok-skip-browser-warning":"true"
    },
    body:JSON.stringify({
      workout_date: workoutDate.value,
      info:{ exercises }
    })
  });

  closeModal();
  loadWorkouts();
}

/* ===== EVENTS (–í–ê–ñ–ù–û) ===== */
fab.addEventListener("click", openAdd);
saveBtn.addEventListener("click", saveWorkout);
addExerciseBtn.addEventListener("click", addExercise);
cancelBtn.addEventListener("click", closeModal);

/* INIT */
loadWorkouts();
</script>
</body>
</html>
