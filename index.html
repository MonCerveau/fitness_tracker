<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  font-family: system-ui, -apple-system;
  margin: 0;
  background: #f2f2f7;
  padding: 16px;
}
.header {
  background: white;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
}
.card {
  background: white;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
}
button {
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  background: #007aff;
  color: white;
  font-size: 14px;
}
button.secondary { background: #8e8e93; }
button.danger { background: #ff3b30; }
.row { display: flex; gap: 8px; margin-top: 8px; }
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: white;
  width: 90%;
  max-width: 340px;
  padding: 16px;
  border-radius: 16px;
}
input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}
.set { display: flex; gap: 6px; margin-bottom: 6px; }
.small { font-size: 13px; color: #666; }
</style>
</head>

<body>

<div class="header">
  <b>üë§ Telegram ID:</b>
  <span id="uid"></span>
</div>

<button onclick="openAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è</h3>
<div id="history"></div>

<!-- –ú–û–î–ê–õ–ö–ê -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>

    <input id="exercise" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">

    <div id="sets"></div>
    <button class="secondary" onclick="addSet()">‚ûï –ü–æ–¥—Ö–æ–¥</button>

    <div class="row">
      <button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

/* üî¥ –í–ê–ñ–ù–û: –¢–û–õ–¨–ö–û –¢–ê–ö */
const telegramId = tg.initDataUnsafe?.user?.id;
document.getElementById("uid").textContent = telegramId;

const API_URL = "https://ula-conductorial-vagrantly.ngrok-free.dev/";

let currentWorkoutId = null;
let sets = [];

/* ---------- UTIL ---------- */
function safeParse(json) {
  try { return JSON.parse(json); }
  catch { return null; }
}

/* ---------- MODAL ---------- */
function openAdd() {
  currentWorkoutId = null;
  document.getElementById("exercise").value = "";
  sets = [];
  document.getElementById("sets").innerHTML = "";
  addSet();
  showModal("–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞");
}

function openEdit(workout) {
  currentWorkoutId = workout.id;
  const info = safeParse(workout.info);
  if (!info) return alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏");

  document.getElementById("exercise").value = info.exercise || "";
  sets = info.sets || [];
  document.getElementById("sets").innerHTML = "";
  sets.forEach(s => addSet(s.weight, s.reps));
  showModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ");
}

function showModal(title) {
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

/* ---------- SETS ---------- */
function addSet(weight="", reps="") {
  const index = sets.length;
  sets.push({ weight, reps });

  const div = document.createElement("div");
  div.className = "set";
  div.innerHTML = `
    <input type="number" placeholder="–∫–≥" value="${weight}"
      onchange="sets[${index}].weight=this.value">
    <input type="number" placeholder="—Ä–∞–∑" value="${reps}"
      onchange="sets[${index}].reps=this.value">
    <button class="danger" onclick="removeSet(${index}, this)">‚úñ</button>
  `;
  document.getElementById("sets").appendChild(div);
}

function removeSet(index, btn) {
  sets[index] = null;
  btn.parentElement.remove();
}

/* ---------- API ---------- */
async function loadHistory() {
  if (!telegramId) {
    alert("Telegram ID –Ω–µ –ø–æ–ª—É—á–µ–Ω");
    return;
  }

  console.log("LOAD workouts for", telegramId);

  const res = await fetch(`${API_URL}/workouts/${telegramId}`);
  const data = await res.json();

  console.log("API DATA:", data);

  const root = document.getElementById("history");
  root.innerHTML = "";

  if (!Array.isArray(data) || data.length === 0) {
    root.innerHTML = "<div class='small'>–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>";
    return;
  }

  data.forEach(w => {
    const info = safeParse(w.info);
    if (!info) return;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <b>${info.exercise}</b>
      <div class="small">${new Date(w.workout_date).toLocaleString()}</div>
      <div class="small">
        ${info.sets.map(s => `${s.weight}–∫–≥ √ó ${s.reps}`).join("<br>")}
      </div>
      <div class="row">
        <button onclick='openEdit(${JSON.stringify(w)})'>‚úèÔ∏è</button>
        <button class="danger" onclick='deleteWorkout(${w.id})'>üóë</button>
      </div>
    `;
    root.appendChild(card);
  });
}

async function saveWorkout() {
  const payload = {
    exercise: document.getElementById("exercise").value,
    sets: sets.filter(Boolean)
  };

  const body = {
    workout_type_id: 1,
    workout_date: new Date().toISOString(),
    info: JSON.stringify(payload)
  };

  await fetch(`${API_URL}/workouts/${telegramId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  closeModal();
  loadHistory();
}

async function deleteWorkout(id) {
  await fetch(`${API_URL}/workouts/${id}`, { method: "DELETE" });
  loadHistory();
}

/* ---------- INIT ---------- */
loadHistory();
</script>

</body>
</html>
